name: CI Pipeline
on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: macos-15

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Add CI platform support
        run: bundle lock --add-platform arm64-darwin-23

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Install dependencies
        run: |
          gem install bundler
          bundle install

      # ───────────────────────────────────────────────────────────────────
      # 3) 워크플로우에서 먼저 Match Repo를 토큰으로 HTTPS 클론
      - name: Manual Clone Match Repo
        run: |
          echo "→ 시도할 URL = https://hyunwook13:${{ secrets.REPO_PAT }}@github.com/hyunwook13/match_repo.git"
          git clone "https://hyunwook13:${{ secrets.REPO_PAT }}@github.com/hyunwook13/match_repo.git" ./_tmp_match_repo
          ls -la ./_tmp_match_repo

      # ───────────────────────────────────────────────────────────────────
      # 4) Fastlane 실행: --env LOCAL_MATCH_REPO="file://..." 로 로컬 클론 경로를 넘겨준다
      - name: Run fastlane custom_release
        run: |
          bundle exec fastlane ios custom_release
        env:
          LOCAL_MATCH_REPO: "file://$(pwd)/_tmp_match_repo"
          FASTLANE_APPLE_API_KEY_KEY_ID:    ${{ secrets.FASTLANE_APPLE_API_KEY_KEY_ID }}
          FASTLANE_APPLE_API_KEY_ISSUER_ID: ${{ secrets.FASTLANE_APPLE_API_KEY_ISSUER_ID }}
          FASTLANE_APPLE_API_KEY_CONTENT:   ${{ secrets.FASTLANE_APPLE_API_KEY_CONTENT }}
          FASTLANE_USER:     ${{ secrets.FASTLANE_USER }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
