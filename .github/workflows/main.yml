# .github/workflows/ci.yml

name: CI Pipeline

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Custom Release
    runs-on: macos-15

    steps:
      # ──────────────────────────────────────────────────────────────────────────────
      # 1) 소스코드 checkout
      - name: actions/checkout
        uses: actions/checkout@v4

      # ──────────────────────────────────────────────────────────────────────────────
      # 2) CI 플랫폼용 lockfile 업데이트 (필요 시, Apple Silicon 지원)
      - name: Add CI platform support
        run: bundle lock --add-platform arm64-darwin-23

      # ──────────────────────────────────────────────────────────────────────────────
      # 3) Ruby 설치
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      # ──────────────────────────────────────────────────────────────────────────────
      # 4) Bundler 및 Gem 의존성 설치
      - name: Install dependencies
        run: |
          gem install bundler
          bundle install

      # ──────────────────────────────────────────────────────────────────────────────
      # 5) Fastlane Apple API Key 파일 생성
      - name: Generate Fastlane API Key files
        run: |
          echo "${{ secrets.FASTLANE_APPLE_API_KEY_CONTENT }}" | base64 -d > fastlane/AuthKey.p8
          echo '{
            "key_id": "'"${{ secrets.FASTLANE_APPLE_API_KEY_KEY_ID }}"'",
            "issuer_id": "'"${{ secrets.FASTLANE_APPLE_API_KEY_ISSUER_ID }}"'",
            "key_filepath": "fastlane/AuthKey.p8"
          }' > fastlane/api_key.json

      # ──────────────────────────────────────────────────────────────────────────────
      # 6) Fastlane 실행 (HTTPS+PAT 방식)
      - name: Run fastlane custom_release
        run: bundle exec fastlane ios custom_release
        env:
          # ── match가 사용하는 Git 저장소 접근용 Token
          MATCH_GIT_URL: ${{ secrets.REPO_PAT }}

          # ── Fastlane Apple API Key 관련 (optional)
          FASTLANE_APPLE_API_KEY_KEY_ID:     ${{ secrets.FASTLANE_APPLE_API_KEY_KEY_ID }}
          FASTLANE_APPLE_API_KEY_ISSUER_ID:  ${{ secrets.FASTLANE_APPLE_API_KEY_ISSUER_ID }}
          FASTLANE_APPLE_API_KEY_CONTENT:    ${{ secrets.FASTLANE_APPLE_API_KEY_CONTENT }}

          # ── Apple ID 로그인 정보 (optional)
          FASTLANE_USER:     ${{ secrets.FASTLANE_USER }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}

          # ── match가 키체인에 쓰는 비밀번호 (optional)
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
