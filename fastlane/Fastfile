default_platform(:ios)

platform :ios do
  desc "ì½”ì½”ì•„íŒŸ ì„¤ì¹˜ â†’ í…ŒìŠ¤íŠ¸ â†’ ì¸ì¦ì„œ ì„¤ì¹˜ â†’ ë¹Œë“œ ë° TestFlight ì—…ë¡œë“œ"
  lane :custom_release do

    # âœ… í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
    scan(
      scheme: "BioLogTests",
      project: "BioLog.xcodeproj",
      fail_build: false,
      skip_build: true,
      clean: true,
      output_types: "html,junit",
      output_directory: "fastlane/test_output",
      build_for_testing: true
    )

    # âœ… CI ì„¤ì •
    setup_ci

    # âœ… ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜
    match

    # âœ… App Store Connect API í‚¤ ì„¤ì •
    api_key = app_store_connect_api_key(
      key_id: ENV["FASTLANE_APPLE_API_KEY_KEY_ID"],
      issuer_id: ENV["FASTLANE_APPLE_API_KEY_ISSUER_ID"],
      key_content: ENV["FASTLANE_APPLE_API_KEY_CONTENT"],
      is_key_content_base64: true
    )
    UI.message("ðŸ”‘ api_key: #{api_key.inspect}")

    # âœ… ë¹Œë“œ ë²ˆí˜¸ ì¦ê°€
    latest_number    = latest_testflight_build_number(app_identifier: "com.Wook.BioLog") || 0
    new_build_number = latest_number + 1

    increment_build_number(
      xcodeproj: "BioLog.xcodeproj",
      build_number: new_build_number
    )

    # âœ… ì•± ë¹Œë“œ
    build_app(
      project: "BioLog.xcodeproj",
      scheme: "BioLog",
      silent: true,
      skip_package_pkg: true,
      export_method: "app-store",
      output_directory: "build",
      output_name: "BioLog.ipa",
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          "com.Wook.BioLog" => "match AppStore com.Wook.BioLog"
        },
        teamID: "D49753ZB3N",
        compileBitcode: false,
        uploadSymbols: true,
        uploadBitcode: false
      },
      export_xcargs: [
        "CODE_SIGN_IDENTITY='Apple Distribution: Hyun Wook Lee (D49753ZB3N)'",
        "DEVELOPMENT_TEAM=D49753ZB3N",
        "PROVISIONING_PROFILE_SPECIFIER='match AppStore com.Wook.BioLog'"
      ].join(" ")
    )

    # âœ… TestFlight ì—…ë¡œë“œ
    pilot(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      wait_processing_timeout_duration: 120,
      ipa: "build/BioLog.ipa"
    )
  end
end
