default_platform(:ios)

platform :ios do
  desc "ì½”ì½”ì•„íŒŸ ì„¤ì¹˜ â†’ í…ŒìŠ¤íŠ¸ â†’ match â†’ ë¹Œë“œ ë° TestFlight ì—…ë¡œë“œ"

  lane :custom_release do
    # 2. í…ŒìŠ¤íŠ¸ (ì‹¤íŒ¨í•´ë„ ì§„í–‰)
    scan(
      scheme: "BioLogTests",
      project: "BioLog.xcodeproj",
      fail_build: false,
      skip_build: true,
      clean: true,
      output_types: "html,junit",
      output_directory: "fastlane/test_output",
      build_for_testing: true
      # destination: "platform=iOS Simulator,name=iPhone 16 Pro,OS=18.1"
    )



    # 3. ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜
    match
#(
 #     type: "appstore",
  #    readonly: true,
   #   git_url: "git@github.com:hyunwook13/match_repo.git"
   #   #clone_branch_directly: true
   # )

  # 2) í‚¤ì²´ì¸ ì–¸ë½ (CI í™˜ê²½ì´ë©´ ê¼­ í•„ìš”)
    keychain_password = ENV["MATCH_KEYCHAIN_PASSWORD"]

    # 2-1. ë¡œê·¸ì¸ í‚¤ì²´ì¸ ì–¸ë½ ì‹œë„ (ë‹¨ì¼ ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ '!' ë¬¸ì œ ë°©ì§€)
    UI.header("ğŸ”“ Unlocking login.keychain-dbâ€¦")
    begin
      unlock_output = sh("security unlock-keychain -p '#{keychain_password}' ~/Library/Keychains/login.keychain-db")
      UI.success("âœ… Keychain unlocked successfully")
    rescue => ex
      UI.error("âŒ Failed to unlock keychain: #{ex.message}")
      raise
    end

    # 2-2. ì¸ì¦ì„œ ëª©ë¡ ì¡°íšŒí•´ì„œ ì¶œë ¥
    UI.header("ğŸ” Fetching code signing identitiesâ€¦")
    begin
      identities = sh("security find-identity -v -p codesigning")
      UI.message("ğŸ”‘ Available code signing identities:\n#{identities}")
    rescue => ex
      UI.error("âš ï¸ No code signing identities found or error: #{ex.message}")
      raise
    end

    # 2-3. ê°œì¸ í‚¤ì— codesign ê¶Œí•œ ê°•ì œ ë¶€ì—¬ (ë‹¨ì¼ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°)
    UI.header("ğŸ” Setting key partition list for codesignâ€¦")
    begin
      sh("security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k '#{keychain_password}' ~/Library/Keychains/login.keychain-db")
      UI.success("âœ… Key partition list set successfully")
    rescue => ex
      UI.error("âŒ Failed to set key partition list: #{ex.message}")
      # í•„ìš”ì— ë”°ë¼ raise í•´ë„ ë˜ê³ , ì„œëª… ë‹¨ê³„ì—ì„œ ë‹¤ì‹œ í™•ì¸ ê°€ëŠ¥
    end

  # 3) App Store ì„œëª… â†’ IPA ìƒì„±
  #build_app(
  #  project:          "BioLog.xcodeproj",
  #  scheme:           "BioLog",
  #  export_method:    "app-store",
  #  output_directory: "build",
  #  output_name:      "BioLog.ipa"
  #)

    # 4. ë¹Œë“œ ë° ì—…ë¡œë“œ
    build_app(
      project: "BioLog.xcodeproj", 
      scheme: "BioLog",
      clean: true,
      silent: true,
      skip_package_pkg: true,
      export_method:    "app-store",
      output_directory: "build",
      output_name:      "BioLog.ipa",
      include_bitcode: false,
      export_options: {
          uploadBitcode: false,
          uploadSymbols: true,
          compileBitcode: false
      }
    )

    api_key = app_store_connect_api_key(
      key_id: ENV["FASTLANE_APPLE_API_KEY_KEY_ID"],
      issuer_id: ENV["FASTLANE_APPLE_API_KEY_ISSUER_ID"],
      key_content: ENV["FASTLANE_APPLE_API_KEY_CONTENT"],
      is_key_content_base64: true
    )
    UI.message("ğŸ”‘ api_key: #{api_key.inspect}")

    pilot(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      wait_processing_timeout_duration: 120,
      ipa: "build/BioLog.ipa"
    )
  end
end
